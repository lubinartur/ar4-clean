<!doctype html>
<html lang="ru" class="dark" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}AIr4{% endblock %}</title>

  <!-- Font: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/app.css" />
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body>
  <!-- Background FX overlay -->
  <div class="bgfx" aria-hidden="true"></div>
  <!-- Particles canvas -->
  <canvas id="particles" aria-hidden="true"></canvas>

  <div class="shell">
        <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-header">
        <div class="logo">‚ú≥Ô∏é</div>
        <div class="brand">AIr4</div>
      </div>

      <div class="sb-search">
        <input type="text" placeholder="Search..." />
      </div>

      <!-- üëâ –¥–æ–±–∞–≤–∏–ª–∏ –æ–±—ë—Ä—Ç–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å—Å—è -->
      <div class="sb-body">
        <nav class="sb-nav">
          <a href="/ui/chat" class="{% if active=='chat' %}active{% endif %}">
            <svg class="ico" viewBox="0 0 24 24"><path d="M21 15V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2Z"/></svg>
            Chat
          </a>
          <a href="/ui/ingest" class="{% if active=='ingest' %}active{% endif %}">
            <svg class="ico" viewBox="0 0 24 24"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 19h16"/></svg>
            Ingest
          </a>
          <a href="/ui/todos" class="{% if active=='todos' %}active{% endif %}">
            <svg class="ico" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4M3 7h6M3 13h6M3 19h6"/></svg>
            Todos
          </a>
          <a href="/ui/summaries" class="{% if active=='summaries' %}active{% endif %}">
            <svg class="ico" viewBox="0 0 24 24"><path d="M3 3v18h18M7 17h3v-4H7zm6 4h3V7h-3z"/></svg>
            Summaries
          </a>
          <a href="/ui/settings" class="{% if active=='settings' %}active{% endif %}">
            <svg class="ico" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm7.4-3c0-.3 0-.7-.1-1l2-1.5-2-3.4-2.3.7c-.5-.4-1.1-.8-1.7-1l-.3-2.4H9l-.3 2.4c-.6.2-1.2.6-1.7 1l-2.3-.7-2 3.4 2 1.5c-.1.3-.1.7-.1 1s0 .7.1 1l-2 1.5 2 3.4 2.3-.7c.5.4 1.1.8 1.7 1l.3 2.4h4.6l.3-2.4c.6-.2 1.2-.6 1.7-1l2.3.7 2-3.4-2-1.5c.1-.3.1-.7.1-1Z"/></svg>
            Settings
          </a>
        </nav>
      <div class="sb-title">Chats</div>
      <div id="sessions"
           hx-get="/ui/sessions"
           hx-trigger="load, every 10s"
           hx-swap="innerHTML">Loading‚Ä¶</div>

        <div class="sb-title">Chats</div>
        <div id="sessions" hx-get="/ui/sessions" hx-trigger="load, every 10s" hx-swap="innerHTML">Loading‚Ä¶</div>
      </div>
      <!-- /sb-body -->

      <div class="sb-footer">
        <div class="user">
          <div class="avatar">üêª</div>
          <div class="meta">
            <div>You</div>
            <div class="sub">local@air4</div>
          </div>
        </div>
        <button id="themeBtn" class="btn ghost" type="button" title="Toggle theme">‚ú≥Ô∏é</button>
      </div>
    </aside>

    <!-- Workspace -->
    <main class="workspace">
      {% block content %}{% endblock %}
      <footer class="footer">v0.9.x ‚Ä¢ Local & Private</footer>
    </main>
  </div>

  <div id="toasts" class="toasts"></div>

  <script src="/static/app.js"></script>
  <script>
  // Theme toggle
  (function(){
    const saved = localStorage.getItem('air4_theme');
    if (saved) {
      document.documentElement.className = saved;
      document.documentElement.setAttribute('data-theme', saved);
    }
    const btn = document.getElementById('themeBtn');
    if (btn) btn.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'light' ? 'dark' : 'light';
      document.documentElement.className = next;
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('air4_theme', next);
    });
  })();

  // Stable headers
  (function(){
    const USER_ID = localStorage.getItem('air4_user') || 'dev';
    if (!localStorage.getItem('air4_session_id')) {
      const rid = (crypto.randomUUID ? crypto.randomUUID() : Date.now());
      localStorage.setItem('air4_session_id', 'sess-' + rid);
    }
    const SID = localStorage.getItem('air4_session_id');
    document.documentElement.setAttribute('hx-headers', JSON.stringify({'X-User': USER_ID,'X-Session': SID}));
    window.__AIR4__ = { USER_ID, SID };
  })();

  // Health badge filler (–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö, –≥–¥–µ –µ—Å—Ç—å #health-badge, –Ω–∞–ø—Ä–∏–º–µ—Ä chat.html)
  (async () => {
    try {
      const r = await fetch('/health', { cache: 'no-store' });
      const j = await r.json();
      const el = document.getElementById('health-badge');
      if (!el) return;
      const backend = j?.memory_backend || 'unknown';
      const offline = j?.offline ? 'offline' : 'online';
      const model   = j?.model || (window.localStorage.getItem('ollama_model') || 'llama3.1:8b');
      el.textContent = `Memory: ${backend} ‚Ä¢ ${model} ‚Ä¢ ${offline}`;
      el.classList.toggle('badge-ok', backend === 'chroma');
    } catch (e) {
      const el = document.getElementById('health-badge');
      if (el) el.textContent = 'Status: error';
    }
  })();

  // Particles background (bright + pulsing)
  (function(){
    const cvs = document.getElementById('particles');
    if (!cvs) return;
    const ctx = cvs.getContext('2d');

    let DPR = Math.min(window.devicePixelRatio || 1, 2);
    let W = 0, H = 0, N = 0, parts = [];
    const CFG = {
      density: 24,
      sizeMin: 0.9, sizeMax: 2.1,
      speed: 0.07,  drift: 0.024,
      alpha: 0.6,   linkDist: 95, linkAlpha: 0.15,
      pulseAmp: 0.35, // –∞–º–ø–ª–∏—Ç—É–¥–∞ –ø—É–ª—å—Å–∞—Ü–∏–∏ —Ä–∞–¥–∏—É—Å–∞ (35%)
      pulseSpd: 0.0018 // —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å—Å–∞ (—Ä–∞–¥/–º—Å)
    };

    function resize(){
      DPR = Math.min(window.devicePixelRatio || 1, 2);
      W = window.innerWidth; H = window.innerHeight;
      cvs.width = Math.floor(W * DPR);
      cvs.height = Math.floor(H * DPR);
      cvs.style.width = W + 'px';
      cvs.style.height = H + 'px';

      const areaMP = (W * H) / 1_000_000;
      N = Math.max(24, Math.floor(areaMP * CFG.density));
      if (parts.length > N) parts.length = N;
      while (parts.length < N) parts.push(spawn());
    }

    function spawn(){
      const rb = rand(CFG.sizeMin, CFG.sizeMax);
      const t = Math.random() * Math.PI * 2;
      return {
        x: Math.random() * W, y: Math.random() * H,
        rb, r: rb, t,
        phase: Math.random() * Math.PI * 2,
        vx: (Math.random()*2 - 1) * CFG.speed,
        vy: (Math.random()*2 - 1) * CFG.speed,
        drift: rand(-CFG.drift, CFG.drift)
      };
    }

    function rand(a,b){ return a + Math.random()*(b-a); }

    let last = 0;
    function tick(ts){
      if (!last) last = ts;
      const dt = Math.min(40, ts - last); last = ts;

      ctx.clearRect(0, 0, cvs.width, cvs.height);
      ctx.save(); ctx.scale(DPR, DPR);

      // glow settings
      ctx.globalAlpha = CFG.alpha;
      ctx.fillStyle = 'rgba(160, 200, 255, 0.95)';
      ctx.shadowColor = 'rgba(160,200,255,0.9)';
      ctx.shadowBlur = 12;

      // update + draw points
      for (let i=0;i<parts.length;i++){
        const p = parts[i];
        p.t += p.drift;
        p.phase += CFG.pulseSpd * dt;

        // motion
        p.x += p.vx * dt; p.y += p.vy * dt;
        p.x += Math.cos(p.t) * 0.022 * dt;
        p.y += Math.sin(p.t*0.9) * 0.020 * dt;

        // pulse radius
        const k = 1 + Math.sin(p.phase) * CFG.pulseAmp;
        p.r = p.rb * k;

        // torus wrap
        if (p.x < -12) p.x = W + 12;
        if (p.x > W + 12) p.x = -12;
        if (p.y < -12) p.y = H + 12;
        if (p.y > H + 12) p.y = -12;

        // draw
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();
      }

      // connection lines
      ctx.lineWidth = 1;
      for (let i=0;i<parts.length;i++){
        const a = parts[i];
        for (let j=i+1;j<parts.length;j++){
          const b = parts[j];
          const dx = a.x - b.x, dy = a.y - b.y;
          const d2 = dx*dx + dy*dy;
          const ld = CFG.linkDist;
          if (d2 < ld*ld){
            const alpha = CFG.linkAlpha * (1 - Math.sqrt(d2)/ld);
            ctx.globalAlpha = alpha * 1.5;
            ctx.strokeStyle = 'rgba(160,200,255,0.8)';
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
          }
        }
      }

      ctx.restore();
      requestAnimationFrame(tick);
    }

    resize();
    window.addEventListener('resize', resize, { passive:true });
    requestAnimationFrame(tick);
  })();
  </script>
</body>
</html>
