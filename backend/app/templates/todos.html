{% extends "base.html" %}
{% block content %}
<h1>Todos</h1>
<p class="dim">Мини-UI поверх существующих API: <code>/todos</code>, <code>/todos/{h}/done|undo</code>, <code>DELETE /todos/{h}</code>.</p>

<div class="stack">
  <div class="row" style="gap:8px; align-items:center">
    <input id="newTodo" placeholder="Новая задача…" style="flex:1" />
    <button id="addBtn" class="btn" type="button">Add</button>
  </div>

  <div class="row" style="gap:8px; align-items:center">
    <span id="counts" class="dim">—</span>
    <div class="row" style="gap:6px; margin-left:8px">
      <button class="btn ghost" id="fltAll"  type="button">All</button>
      <button class="btn ghost" id="fltOpen" type="button">Active</button>
      <button class="btn ghost" id="fltDone" type="button">Done</button>
    </div>
  </div>

  <div class="card" style="padding:0">
    <table style="width:100%; border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left; padding:10px 12px">Task</th>
          <th style="text-align:left; padding:10px 12px; width:110px">Status</th>
          <th style="text-align:right; padding:10px 12px; width:190px">Actions</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <div id="status" class="dim"></div>
</div>

<script>
(function(){
  const listEl = document.getElementById('list');
  const newTodo = document.getElementById('newTodo');
  const addBtn = document.getElementById('addBtn');
  const counts = document.getElementById('counts');
  const status = document.getElementById('status');

  const fltAll  = document.getElementById('fltAll');
  const fltOpen = document.getElementById('fltOpen');
  const fltDone = document.getElementById('fltDone');

  let items = [];
  let filter = 'all'; // all | open | done

  function setBusy(btn, v){ if (v) btn.setAttribute('aria-busy','true'); else btn.removeAttribute('aria-busy'); btn.disabled = !!v; }
  function flash(t){ status.textContent = t; setTimeout(()=> status.textContent = '', 1500); }
  function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function applyFilter(src){
    if (filter === 'open') return src.filter(x => !x.done);
    if (filter === 'done') return src.filter(x =>  x.done);
    return src;
  }

  function render(){
    const view = applyFilter(items);
    if (!view.length){
      listEl.innerHTML = `<tr><td colspan="3" style="padding:16px; opacity:.7">Пусто</td></tr>`;
    } else {
      listEl.innerHTML = view.map(it => {
        const text = esc(it.text || '');
        const badge = it.done ? '<span class="tag success">done</span>' : '<span class="tag">active</span>';
        const act1  = it.done ? 'Undo' : 'Done';
        return `
          <tr data-h="${it.h}">
            <td style="padding:10px 12px; ${it.done ? 'opacity:.7; text-decoration:line-through;' : ''}">${text}</td>
            <td style="padding:10px 12px">${badge}</td>
            <td style="padding:8px 12px; text-align:right">
              <button class="btn ghost small" data-action="toggle">${act1}</button>
              <button class="btn ghost small" data-action="del" style="margin-left:6px">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    const open = items.filter(x=>!x.done).length;
    const done = items.length - open;
    counts.textContent = `Total: ${items.length} • Active: ${open} • Done: ${done}`;

    // выделяем активный фильтр
    [fltAll, fltOpen, fltDone].forEach(b => b.classList.remove('primary'));
    ({all: fltAll, open: fltOpen, done: fltDone})[filter].classList.add('primary');
  }

  async function load(){
    try{
      const r = await fetch('/todos');
      items = await r.json();
      render();
    }catch(e){
      flash('NETWORK ERROR');
    }
  }

  async function add(){
    const text = (newTodo.value || '').trim();
    if (!text) return;
    setBusy(addBtn, true);
    try{
      const r = await fetch('/todos', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})});
      if (r.ok){
        newTodo.value = '';
        await load();
      } else {
        flash(`Ошибка: ${r.status}`);
      }
    }catch(e){ flash('NETWORK ERROR'); }
    finally{ setBusy(addBtn, false); }
  }

  async function toggle(h, done){
    try{
      const url = done ? `/todos/${encodeURIComponent(h)}/undo` : `/todos/${encodeURIComponent(h)}/done`;
      const r = await fetch(url, {method:'POST'});
      if (r.ok) await load(); else flash(`Ошибка: ${r.status}`);
    }catch(e){ flash('NETWORK ERROR'); }
  }

  async function del(h){
    try{
      const r = await fetch(`/todos/${encodeURIComponent(h)}`, {method:'DELETE'});
      if (r.ok) await load(); else flash(`Ошибка: ${r.status}`);
    }catch(e){ flash('NETWORK ERROR'); }
  }

  // UI events
  addBtn.addEventListener('click', add);
  newTodo.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') add(); });

  listEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if (!btn) return;
    const tr = e.target.closest('tr'); if (!tr) return;
    const h = tr.getAttribute('data-h');
    if (!h) return;
    const it = items.find(x => x.h === h);
    if (!it) return;
    const action = btn.getAttribute('data-action');
    if (action === 'toggle') toggle(h, it.done);
    else if (action === 'del') del(h);
  });

  fltAll.addEventListener('click', ()=>{ filter='all';  render(); });
  fltOpen.addEventListener('click',()=>{ filter='open'; render(); });
  fltDone.addEventListener('click',()=>{ filter='done'; render(); });

  // init
  load();
})();
</script>
{% endblock %}
